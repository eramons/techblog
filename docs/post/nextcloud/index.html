<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en">

<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">






    <meta name="description" content="Goal:
Self-host Nextcloud on Kubernetes and use it as server-side for the /e operating system
Nextcloud offers an on-premises content collaboration platform, which is open-source and free. The Nextcloud server is written in the PHP and JavaScript scripting languages.
The /e/ ROM is a fork of Android (more precisely from LineageOS).
See previous post to see how to install the OS on a LG G3 and my efforts to self-host the /e server beta version.">



    
    
        
    

    


    <title>Nextcloud self-hosting on K8s | Small Technical Blog</title>

    <link rel="apple-touch-icon" sizes="180x180" href="/techblog/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/techblog/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/techblog/favicon/favicon-16x16.png">

    

    <meta property="og:title" content="Nextcloud self-hosting on K8s" />
<meta property="og:description" content="Goal:
Self-host Nextcloud on Kubernetes and use it as server-side for the /e operating system
Nextcloud offers an on-premises content collaboration platform, which is open-source and free. The Nextcloud server is written in the PHP and JavaScript scripting languages.
The /e/ ROM is a fork of Android (more precisely from LineageOS).
See previous post to see how to install the OS on a LG G3 and my efforts to self-host the /e server beta version." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://eramons.github.io/techblog/post/nextcloud/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-01-07T09:00:00+02:00" />
<meta property="article:modified_time" content="2021-01-07T09:00:00+02:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Nextcloud self-hosting on K8s"/>
<meta name="twitter:description" content="Goal:
Self-host Nextcloud on Kubernetes and use it as server-side for the /e operating system
Nextcloud offers an on-premises content collaboration platform, which is open-source and free. The Nextcloud server is written in the PHP and JavaScript scripting languages.
The /e/ ROM is a fork of Android (more precisely from LineageOS).
See previous post to see how to install the OS on a LG G3 and my efforts to self-host the /e server beta version."/>


    <link rel="preload" as="font" href="/techblog/fonts/Metropolis.woff2" type="font/woff2" crossorigin="anonymous">
<link rel="preload" as="font" href="/techblog/fonts/LiberationSans.woff2" type="font/woff2" crossorigin="anonymous">
<link rel="preload" as="font" href="/techblog/fonts/LiberationSans-Bold.woff2" type="font/woff2" crossorigin="anonymous">
<link rel="preload" as="font" href="/techblog/fonts/LiberationSans-BoldItalic.woff2" type="font/woff2" crossorigin="anonymous">
<link rel="preload" as="font" href="/techblog/fonts/LiberationSans-Italic.woff2" type="font/woff2" crossorigin="anonymous">
<link rel="preload" as="font" href="/techblog/fonts/LiberationMono.woff2" type="font/woff2" crossorigin="anonymous">
<link rel="preload" as="font" href="/techblog/fonts/DroidSans.woff2" type="font/woff2" crossorigin="anonymous">
<link rel="preload" as="font" href="/techblog/fonts/GeekblogIcons.woff2" type="font/woff2" crossorigin="anonymous">

<link rel="preload" href="/techblog/main-85732d8853.min.css" as="style">
<link rel="stylesheet" href="/techblog/main-85732d8853.min.css" media="all">

<link rel="preload" href="/techblog/mobile-14fbbb71d2.min.css" as="style">
<link rel="stylesheet" href="/techblog/mobile-14fbbb71d2.min.css" media="screen and (max-width: 45rem)">

<link rel="preload" href="/techblog/print-86167e859a.min.css" as="style">
<link rel="stylesheet" href="/techblog/print-86167e859a.min.css" media="print">

<link rel="preload" href="/techblog/custom.css" as="style">
<link rel="stylesheet" href="/techblog/custom.css" media="all">



<!-- Made with Geekblog theme https://github.com/thegeeklab/hugo-geekblog -->

    




<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "articleSection": "post",
    "name": "Nextcloud self-hosting on K8s",
    "headline": "Nextcloud self-hosting on K8s",
    "alternativeHeadline": "",
    "description": "Goal:\nSelf-host Nextcloud on Kubernetes and use it as server-side for the \/e operating system\nNextcloud offers an on-premises content collaboration platform, which is open-source and free. The Nextcloud server is written in the PHP and JavaScript scripting languages.\nThe \/e\/ ROM is a fork of Android (more precisely from LineageOS).\nSee previous post to see how to install the OS on a LG G3 and my efforts to self-host the \/e server beta version.",
    "inLanguage": "en",
    "isFamilyFriendly": "true",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https:\/\/eramons.github.io\/techblog\/post\/nextcloud\/"
    },
    "author" : [
    ],
    "copyrightHolder" : "Small Technical Blog",
    "copyrightYear" : "2021",
    "dateCreated": "2021-01-07T09:00:00.00Z",
    "datePublished": "2021-01-07T09:00:00.00Z",
    "dateModified": "2021-01-07T09:00:00.00Z",
    "publisher":{
        "@type":"Organization",
        "name": "Small Technical Blog",
        "url": "https://eramons.github.io/techblog/",
        "logo": {
            "@type": "ImageObject",
            "url": "https:\/\/eramons.github.io\/techblog\/eve.png",
            "width":"32",
            "height":"32"
        }
    },
    "url" : "https:\/\/eramons.github.io\/techblog\/post\/nextcloud\/",
    "wordCount" : "2449",
    "genre" : [ "nextcloud" , "\/e" , "kubernetes" ]
}
</script>


</head>

<body>
    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><symbol viewBox="-7.27 -7.27 46.55 46.55" id="arrow_back" xmlns="http://www.w3.org/2000/svg"><path d="M31.999 14.035v3.93H7.673l11.134 11.228L16 32 .001 16.001 16 .002l2.807 2.807L7.673 14.037h24.326z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="arrow_left" xmlns="http://www.w3.org/2000/svg"><path d="M7.954 17.965v5.988L.001 16l7.953-7.953v5.988H32v3.93H7.954z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="arrow_right" xmlns="http://www.w3.org/2000/svg"><path d="M24.046 14.035V8.047L31.999 16l-7.953 7.953v-5.988H0v-3.93h24.046z"/></symbol><symbol viewBox="-7.27 -7.27 42.55 42.55" id="bitbucket" xmlns="http://www.w3.org/2000/svg"><path d="M15.905 13.355c.189 1.444-1.564 2.578-2.784 1.839-1.375-.602-1.375-2.784-.034-3.403 1.151-.705 2.818.223 2.818 1.564zm1.907-.361c-.309-2.44-3.076-4.056-5.328-3.042-1.426.636-2.389 2.148-2.32 3.747.086 2.097 2.08 3.815 4.176 3.626s3.729-2.234 3.472-4.331zm4.108-9.315c-.756-.997-2.045-1.169-3.179-1.358-3.214-.516-6.513-.533-9.727.034-1.066.172-2.269.361-2.939 1.323 1.1 1.031 2.664 1.186 4.073 1.358 2.544.327 5.156.344 7.699.017 1.426-.172 3.008-.309 4.073-1.375zm.979 17.788c-.481 1.684-.206 3.953-1.994 4.932-3.076 1.701-6.806 1.89-10.191 1.289-1.787-.327-3.884-.894-4.864-2.578-.43-1.65-.705-3.334-.98-5.018l.103-.275.309-.155c5.121 3.386 12.288 3.386 17.427 0 .808.241.206 1.22.189 1.805zM26.01 4.951c-.584 3.764-1.255 7.51-1.908 11.257-.189 1.1-1.255 1.719-2.148 2.183-3.214 1.615-6.96 1.89-10.483 1.512-2.389-.258-4.829-.894-6.771-2.389-.911-.705-.911-1.908-1.083-2.922-.602-3.523-1.289-7.046-1.719-10.604.206-1.547 1.942-2.217 3.231-2.698C6.848.654 8.686.362 10.508.19c3.884-.378 7.854-.241 11.618.859 1.341.395 2.784.945 3.695 2.097.412.533.275 1.203.189 1.805z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="bookmarks" xmlns="http://www.w3.org/2000/svg"><path d="M20.357 5.856q1.157 0 2.043.851t.885 2.008v23.284l-10.212-4.357-10.144 4.357V8.715q0-1.157.885-2.008t2.042-.851h14.502zm5.787 18.859V5.856q0-1.157-.851-2.042t-2.008-.885H8.715q0-1.157.885-2.042t2.043-.885h14.502q1.157 0 2.043.885t.885 2.042v23.216z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="clear" xmlns="http://www.w3.org/2000/svg"><path d="M32 3.222L19.222 16 32 28.778l-3.221 3.221-12.778-12.778L3.223 31.999.002 28.778 12.78 16 .002 3.222 3.223.001l12.778 12.778L28.779.001z"/></symbol><symbol viewBox="-7.27 -7.27 42.55 42.55" id="code" xmlns="http://www.w3.org/2000/svg"><path d="M9.917 24.5a1.75 1.75 0 10-3.501.001 1.75 1.75 0 003.501-.001zm0-21a1.75 1.75 0 10-3.501.001A1.75 1.75 0 009.917 3.5zm11.666 2.333a1.75 1.75 0 10-3.501.001 1.75 1.75 0 003.501-.001zm1.75 0a3.502 3.502 0 01-1.75 3.026c-.055 6.581-4.721 8.039-7.82 9.023-2.898.911-3.846 1.349-3.846 3.117v.474a3.502 3.502 0 011.75 3.026c0 1.932-1.568 3.5-3.5 3.5s-3.5-1.568-3.5-3.5c0-1.294.711-2.424 1.75-3.026V6.526A3.502 3.502 0 014.667 3.5c0-1.932 1.568-3.5 3.5-3.5s3.5 1.568 3.5 3.5a3.502 3.502 0 01-1.75 3.026v9.06c.93-.456 1.914-.766 2.807-1.039 3.391-1.075 5.323-1.878 5.359-5.687a3.502 3.502 0 01-1.75-3.026c0-1.932 1.568-3.5 3.5-3.5s3.5 1.568 3.5 3.5z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="contacts" xmlns="http://www.w3.org/2000/svg"><path d="M22.688 22.688v-2q0-1.5-2.281-2.438t-4.406-.938-4.406.938-2.281 2.438v2h13.375zM16 9q-1.25 0-2.125.875T13 12t.875 2.125T16 15t2.125-.875T19 12t-.875-2.125T16 9zm10.688-3.687q1.063 0 1.844.813t.781 1.875v16q0 1.063-.781 1.875t-1.844.813H5.313q-1.063 0-1.844-.813t-.781-1.875v-16q0-1.063.781-1.875t1.844-.813h21.375zM5.313 32v-2.688h21.375V32H5.313zM26.688 0v2.688H5.313V0h21.375z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="create" xmlns="http://www.w3.org/2000/svg"><path d="M31.499 7.167l-3.25 3.25-6.666-6.666 3.25-3.25q.5-.5 1.25-.5t1.25.5l4.166 4.166q.5.5.5 1.25t-.5 1.25zM.001 25.333L19.667 5.667l6.666 6.666L6.667 31.999H.001v-6.666z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="date" xmlns="http://www.w3.org/2000/svg"><path d="M27.192 28.844V11.192H4.808v17.652h22.384zm0-25.689q1.277 0 2.253.976t.976 2.253v22.459q0 1.277-.976 2.216t-2.253.939H4.808q-1.352 0-2.291-.901t-.939-2.253V6.385q0-1.277.939-2.253t2.291-.976h1.577V.001h3.23v3.155h12.769V.001h3.23v3.155h1.577zm-3.155 11.267v3.155h-3.23v-3.155h3.23zm-6.46 0v3.155h-3.155v-3.155h3.155zm-6.384 0v3.155h-3.23v-3.155h3.23z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="download" xmlns="http://www.w3.org/2000/svg"><path d="M2.866 28.209h26.269v3.79H2.866v-3.79zm26.268-16.925L16 24.418 2.866 11.284h7.493V.001h11.283v11.283h7.493z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="email" xmlns="http://www.w3.org/2000/svg"><path d="M28.845 9.615v-3.23L16 14.422 3.155 6.385v3.23L16 17.577zm0-6.46q1.277 0 2.216.977T32 6.385v19.23q0 1.277-.939 2.253t-2.216.977H3.155q-1.277 0-2.216-.977T0 25.615V6.385q0-1.277.939-2.253t2.216-.977h25.69z"/></symbol><symbol viewBox="-7.27 -7.27 42.55 42.55" id="git" xmlns="http://www.w3.org/2000/svg"><path d="M27.472 12.753L15.247.529a1.803 1.803 0 00-2.55 0l-2.84 2.84 2.137 2.137a2.625 2.625 0 013.501 3.501l3.499 3.499a2.625 2.625 0 11-1.237 1.237l-3.499-3.499c-.083.04-.169.075-.257.106v7.3a2.626 2.626 0 11-1.75 0v-7.3a2.626 2.626 0 01-1.494-3.607L8.62 4.606l-8.09 8.09a1.805 1.805 0 000 2.551l12.225 12.224a1.803 1.803 0 002.55 0l12.168-12.168a1.805 1.805 0 000-2.551z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="github" xmlns="http://www.w3.org/2000/svg"><path d="M16 .394c8.833 0 15.999 7.166 15.999 15.999 0 7.062-4.583 13.062-10.937 15.187-.813.146-1.104-.354-1.104-.771 0-.521.021-2.25.021-4.396 0-1.5-.5-2.458-1.083-2.958 3.562-.396 7.312-1.75 7.312-7.896 0-1.75-.625-3.167-1.646-4.291.167-.417.708-2.042-.167-4.25-1.333-.417-4.396 1.646-4.396 1.646a15.032 15.032 0 00-8 0S8.937 6.602 7.603 7.018c-.875 2.208-.333 3.833-.167 4.25-1.021 1.125-1.646 2.542-1.646 4.291 0 6.125 3.729 7.5 7.291 7.896-.458.417-.875 1.125-1.021 2.146-.917.417-3.25 1.125-4.646-1.333-.875-1.521-2.458-1.646-2.458-1.646-1.562-.021-.104.979-.104.979 1.042.479 1.771 2.333 1.771 2.333.938 2.854 5.396 1.896 5.396 1.896 0 1.333.021 2.583.021 2.979 0 .417-.292.917-1.104.771C4.582 29.455-.001 23.455-.001 16.393-.001 7.56 7.165.394 15.998.394zM6.063 23.372c.042-.083-.021-.187-.146-.25-.125-.042-.229-.021-.271.042-.042.083.021.187.146.25.104.062.229.042.271-.042zm.646.709c.083-.062.062-.208-.042-.333-.104-.104-.25-.146-.333-.062-.083.062-.062.208.042.333.104.104.25.146.333.062zm.625.937c.104-.083.104-.25 0-.396-.083-.146-.25-.208-.354-.125-.104.062-.104.229 0 .375s.271.208.354.146zm.875.875c.083-.083.042-.271-.083-.396-.146-.146-.333-.167-.417-.062-.104.083-.062.271.083.396.146.146.333.167.417.062zm1.187.521c.042-.125-.083-.271-.271-.333-.167-.042-.354.021-.396.146s.083.271.271.312c.167.062.354 0 .396-.125zm1.313.104c0-.146-.167-.25-.354-.229-.187 0-.333.104-.333.229 0 .146.146.25.354.229.187 0 .333-.104.333-.229zm1.208-.208c-.021-.125-.187-.208-.375-.187-.187.042-.312.167-.292.312.021.125.187.208.375.167s.312-.167.292-.292z"/></symbol><symbol viewBox="-7.27 -7.27 42.55 42.55" id="gitlab" xmlns="http://www.w3.org/2000/svg"><path d="M1.629 11.034L14 26.888.442 17.048a1.09 1.09 0 01-.39-1.203l1.578-4.811zm7.217 0h10.309l-5.154 15.854zM5.753 1.475l3.093 9.559H1.63l3.093-9.559a.548.548 0 011.031 0zm20.618 9.559l1.578 4.811c.141.437-.016.922-.39 1.203l-13.558 9.84 12.371-15.854zm0 0h-7.216l3.093-9.559a.548.548 0 011.031 0z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="heart" xmlns="http://www.w3.org/2000/svg"><path d="M16 29.714a1.11 1.11 0 01-.786-.321L4.072 18.643c-.143-.125-4.071-3.714-4.071-8 0-5.232 3.196-8.357 8.535-8.357 3.125 0 6.053 2.464 7.464 3.857 1.411-1.393 4.339-3.857 7.464-3.857 5.339 0 8.535 3.125 8.535 8.357 0 4.286-3.928 7.875-4.089 8.035L16.785 29.392c-.214.214-.5.321-.786.321z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="keyborad_arrow_left" xmlns="http://www.w3.org/2000/svg"><path d="M25.875 28.25L22.125 32 6.126 16.001 22.125.002l3.75 3.75-12.25 12.25z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="keyborad_arrow_right" xmlns="http://www.w3.org/2000/svg"><path d="M6.125 28.25L18.375 16 6.125 3.75 9.875 0l15.999 15.999L9.875 31.998z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="link" xmlns="http://www.w3.org/2000/svg"><path d="M24.037 7.963q3.305 0 5.634 2.366T32 16t-2.329 5.671-5.634 2.366h-6.46v-3.08h6.46q2.028 0 3.493-1.465t1.465-3.493-1.465-3.493-3.493-1.465h-6.46v-3.08h6.46zM9.615 17.578v-3.155h12.77v3.155H9.615zM3.005 16q0 2.028 1.465 3.493t3.493 1.465h6.46v3.08h-6.46q-3.305 0-5.634-2.366T0 16.001t2.329-5.671 5.634-2.366h6.46v3.08h-6.46q-2.028 0-3.493 1.465t-1.465 3.493z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="menu" xmlns="http://www.w3.org/2000/svg"><path d="M.001 5.334h31.998v3.583H.001V5.334zm0 12.416v-3.5h31.998v3.5H.001zm0 8.916v-3.583h31.998v3.583H.001z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="notifications" xmlns="http://www.w3.org/2000/svg"><path d="M25.846 22.154l3.308 3.308v1.615H2.847v-1.615l3.308-3.308V14q0-3.846 1.961-6.692t5.423-3.692V2.462q0-1 .692-1.731T16 0t1.769.731.692 1.731v1.154q3.461.846 5.423 3.692T25.846 14v8.154zM16 32q-1.385 0-2.346-.923t-.962-2.308h6.615q0 1.308-1 2.269T15.999 32z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="person" xmlns="http://www.w3.org/2000/svg"><path d="M16 20.023q5.052 0 10.526 2.199t5.473 5.754v4.023H0v-4.023q0-3.555 5.473-5.754t10.526-2.199zM16 16q-3.275 0-5.614-2.339T8.047 8.047t2.339-5.661T16 0t5.614 2.386 2.339 5.661-2.339 5.614T16 16z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="pin" xmlns="http://www.w3.org/2000/svg"><path d="M17.6 19.2h9.6v-1.6L22.4 16V3.2l4.8-1.6V0H4.8v1.6l4.8 1.6V16l-4.8 1.6v1.6h9.6v11.2L16 32l1.6-1.6V19.2z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="rss_feed" xmlns="http://www.w3.org/2000/svg"><path d="M-.481 12.048q8.482 0 14.457 5.976t5.976 14.457h-5.879q0-5.976-4.289-10.264T-.48 17.928v-5.879zm0-11.565q13.204 0 22.601 9.397t9.397 22.601h-5.783q0-10.891-7.662-18.553T-.481 6.266V.483zm0 27.468q0-1.831 1.301-3.132t3.229-1.301 3.181 1.253 1.253 3.181-1.301 3.229-3.132 1.301q-1.928 0-3.229-1.301T-.48 27.952z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="search" xmlns="http://www.w3.org/2000/svg"><path d="M11.925 20.161q3.432 0 5.834-2.402t2.402-5.834-2.402-5.834-5.834-2.402-5.834 2.402-2.402 5.834 2.402 5.834 5.834 2.402zm10.981 0L32 29.255 29.255 32l-9.094-9.094v-1.458l-.515-.515q-3.26 2.831-7.721 2.831-4.976 0-8.45-3.432T.001 11.925t3.474-8.45 8.45-3.474 8.407 3.474 3.432 8.45q0 1.802-.858 4.075t-1.973 3.646l.515.515h1.458z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="security" xmlns="http://www.w3.org/2000/svg"><path d="M16 0l13.072 5.855v8.715q0 6.059-3.745 11.063T16 31.999q-5.583-1.362-9.327-6.366T2.928 14.57V5.855zm0 16v13.004q4.017-1.294 6.808-4.868T26.144 16H16zm0 0V3.2L5.856 7.693v8.306H16z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="telescope" xmlns="http://www.w3.org/2000/svg"><path d="M25.026 3.335a.466.466 0 00-.646-.238L13.362 8.91a.463.463 0 00-.216.575l.227.593-6.36 3.488a.462.462 0 00-.205.583l.211.508-6.755 3.228a.463.463 0 00-.228.595l1.386 3.341a.463.463 0 00.583.259l7.056-2.5.211.508a.462.462 0 00.557.267l6.733-1.941.202.527a.46.46 0 00.566.277l12.03-3.702a.46.46 0 00.293-.613L25.026 3.335zM2.109 21.061l-1.049-2.53 6.314-3.018 1.332 3.211-6.596 2.337zm7.857-1.708l-.22-.531-1.706-4.113-.22-.53 5.863-3.216 2.197 5.676.347.908-6.261 1.806zm7.505-1.146l-.188-.491c-.003-.01-.001-.022-.006-.032l-.572-1.478-2.549-6.668 10.201-5.381 4.249 10.624-11.136 3.428zm8.943-16.723a.463.463 0 00-.86.344l5.552 13.881a.464.464 0 00.602.258.464.464 0 00.258-.602L26.413 1.484zM16.268 20.627h-2.776c-1.055 0-1.851.796-1.851 1.851v1.217l-5.44 6.347a.462.462 0 10.702.602l5.415-6.316h2.101v6.015a.463.463 0 00.926 0v-6.015h2.101l5.414 6.316a.462.462 0 10.703-.602l-5.44-6.347v-1.148c0-1.076-.813-1.92-1.851-1.92zm.925 2.777h-4.627v-.925c0-.545.38-.925.925-.925h2.776c.527 0 .925.428.925.995v.856z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="timer" xmlns="http://www.w3.org/2000/svg"><path d="M16 29q4.428 0 7.536-3.143t3.107-7.571-3.107-7.536T16 7.643 8.464 10.75t-3.107 7.536 3.107 7.571T16 29zM26.714 9.786q1.214 1.571 2.107 4.036t.893 4.464q0 5.643-4 9.678T16 32t-9.714-4.036-4-9.678 4-9.678T16 4.572q1.929 0 4.464.929t4.107 2.143l2.143-2.214q1.143.929 2.143 2.143zM14.5 19.857v-9.143h3v9.143h-3zM20.571.001v3.071h-9.143V.001h9.143z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="tree" xmlns="http://www.w3.org/2000/svg"><path d="M32 14.423H20.808V9.616h-3.23v12.77h3.23v-4.807H32v12.845H20.808v-4.807h-6.385v-16h-3.23v4.807H.001V1.579h11.192v4.807h9.615V1.579H32v12.845z"/></symbol></svg>

    <div class="wrapper">
        <header class="gblog-header">
    <div class="container flex align-center justify-center">
        <a class="gblog-header__link" rel="me" href="https://eramons.github.io/techblog/">
            <span class="gblog-brand flex align-center justify-center">
                <img class="gblog-brand__img" src="/techblog/eve.png" alt="" width=60 height=60>
                Small Technical Blog
            </span>
            
            <span class="gblog-brand__subtitle flex align-center justify-center">E. Ramon</span>
            
        </a>
    </div>
</header>
<nav class="gblog-nav">
    <input type="checkbox" id="menu-control" class="hidden">
    <div class="gblog-nav__control">
        <label for="menu-control"  class="flex align-center justify-center">
            <svg class="icon menu"><use xlink:href="#menu"></use></svg>
            <svg class="icon clear"><use xlink:href="#clear"></use></svg>
            <span>Nav</span>
        </label>
    </div>
    <ul class="gblog-nav__list container flex flex-wrap justify-center menu-content">
        
        
        
        
        
        <li>
            <a class="gblog-nav__entry " href="/techblog/tags/android/">android</a>
        </li>
        
        
        
        <li>
            <a class="gblog-nav__entry " href="/techblog/tags/arm/">arm</a>
        </li>
        
        
        
        <li>
            <a class="gblog-nav__entry " href="/techblog/tags/asahi/">asahi</a>
        </li>
        
        
        
        <li>
            <a class="gblog-nav__entry " href="/techblog/tags/coreboot/">coreboot</a>
        </li>
        
        
        
        <li>
            <a class="gblog-nav__entry " href="/techblog/tags/cozy/">cozy</a>
        </li>
        
        
        
        <li>
            <a class="gblog-nav__entry " href="/techblog/tags/debian/">debian</a>
        </li>
        
        
        
        <li>
            <a class="gblog-nav__entry " href="/techblog/tags/home-automation/">home automation</a>
        </li>
        
        
        
        <li>
            <a class="gblog-nav__entry " href="/techblog/tags/kubernetes/">kubernetes</a>
        </li>
        
        
        
        <li>
            <a class="gblog-nav__entry " href="/techblog/tags/networking/">networking</a>
        </li>
        
        
        
        <li>
            <a class="gblog-nav__entry " href="/techblog/tags/nextcloud/">nextcloud</a>
        </li>
        
        
        
        <li>
            <a class="gblog-nav__entry " href="/techblog/tags/u-boot/">u-boot</a>
        </li>
        
        
    </ul>
</nav>


        <main class="gblog-page container">
            
    <article class="gblog-post">
        <header class="gblog-post__header">
            
            

            <h1>Nextcloud self-hosting on K8s</h1>
            
            <div class="gblog-post__meta">
                <span class="no-wrap">
                    <svg class="icon date"><use xlink:href="#date"></use></svg>
                    <span class="gblog-post__tag">
                        <time datetime="2021-01-07T09:00:00&#43;02:00">
                            
                            Jan 7, 2021
                        </time>
                    </span>
                </span>

                <span class="no-wrap">
                    <svg class="icon timer"><use xlink:href="#timer"></use></svg>
                    <span class="gblog-post__tag">12 min read</span>
                </span>
            </div>
            
        </header>

        <section class="gblog-markdown">
            



    


<p><strong>Goal:</strong></p>
<p><em>Self-host Nextcloud on Kubernetes and use it as server-side for the /e operating system</em></p>
<p>Nextcloud offers an on-premises content collaboration platform, which is open-source and free. The Nextcloud server is written in the PHP and JavaScript scripting languages.</p>
<p>The /e/ ROM is a fork of Android (more precisely from LineageOS).</p>
<p><em>See previous post to see how to install the OS on a LG G3 and my efforts to self-host the /e server beta version.</em></p>
<p>The /e self-hosting exercise turned to be quite cumbersome due to the installation script of the beta version, which is one of these <em>do-everything-in-one</em> scripts difficult to troubleshoot und which makes maintenance and updates overly complicated.</p>
<p>However, the /e server-side is in fact just a composition of services and their configuration:</p>
<ul>
<li>Nextcloud, as file synchronization software</li>
<li>Postfix, to host the own mail server</li>
<li>OnlyOffice, to allow editing of documents</li>
</ul>
<p>I was actually only intereeted in photos and files synchronization. Basing on this premise, I deciced to try to install Nextcloud directly and see if I could use it as the server side for the /e operating system on the phone. The nice guys in charge of /e development told me that this should be possible and advise me to do so.</p>
<p>As a hosting environment I wanted to use Kubernetes - as usual. This time - instead of deploying directly on either my K8s or my K3s cluster on premises - I wanted to try the Digital Ocean K8s services. If the experiment was succesfull, I would move the setup to my home network afterwards, to use nextcloud to sync my files and photos.</p>
<p><em>NOTE: another reason was that by the time of this writting I was on vacation with no access to my home network ;)</em></p>
<div class="gblog-post__anchorwrap"><h2 id="pre-conditions">Pre-conditions<a data-clipboard-text="https://eramons.github.io/techblog/post/nextcloud/#pre-conditions" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Pre-conditions" href="#pre-conditions"><svg class="icon link"><use xlink:href="#link"></use></svg></a></h2></div>
<ul>
<li>A DigitalOcean account to host the K8s cluster</li>
<li>A client device to test the installation</li>
<li>A hosted public domain (<em>mydomain.com</em>)</li>
<li>A DNS provider to register the necessary DNS entries</li>
</ul>
<p>I had a DigitalOcean account and I was still enjoying the free credit I got when signing up for the first time. The client device will be the LG G3 where /e already was running. My public domain was hosted by GoDaddy and as DNS provider I would use Cloudfare as I always do.</p>
<div class="gblog-post__anchorwrap"><h2 id="milestones">Milestones<a data-clipboard-text="https://eramons.github.io/techblog/post/nextcloud/#milestones" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Milestones" href="#milestones"><svg class="icon link"><use xlink:href="#link"></use></svg></a></h2></div>
<ol>
<li>Set up a K8s cluster on DigitalOcean</li>
<li>Identify software components and write K8s manifests</li>
<li>Set up DNS</li>
<li>Ingress</li>
<li>Certmanager and cluster issuer</li>
<li>Deployment with Kustomize</li>
<li>Register /e client with nextcloud account</li>
</ol>
<div class="gblog-post__anchorwrap"><h2 id="1-set-up-a-k8s-cluster">1. Set up a K8s cluster<a data-clipboard-text="https://eramons.github.io/techblog/post/nextcloud/#1-set-up-a-k8s-cluster" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 1. Set up a K8s cluster" href="#1-set-up-a-k8s-cluster"><svg class="icon link"><use xlink:href="#link"></use></svg></a></h2></div>
<div class="gblog-post__anchorwrap"><h3 id="11-create-and-configure-the-new-cluster">1.1. Create and configure the new cluster<a data-clipboard-text="https://eramons.github.io/techblog/post/nextcloud/#11-create-and-configure-the-new-cluster" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 1.1. Create and configure the new cluster" href="#11-create-and-configure-the-new-cluster"><svg class="icon link"><use xlink:href="#link"></use></svg></a></h3></div>
<p>Setting up a K8s cluster on DigitalOcean was easy:</p>
<ul>
<li>I selected the latest K8s version, which was the default</li>
<li>I selected the datacenter closest to my current location</li>
<li>I selected one single <em>basic node</em> with <em>2.5 GB RAM usable (4 GB Total)/2 vCPUs</em></li>
<li>As cluster name, I typed <em>eramonk8s</em></li>
</ul>
<p><em>NOTE: jumping a little ahead, I have to say this setup was painfully slow. More nodes and a little more RAM would have been more convenient.</em></p>
<div class="gblog-post__anchorwrap"><h3 id="12-install-and-configure-_kubectl_-and-_doctl_">1.2. Install and configure <em>kubectl</em> and <em>doctl</em><a data-clipboard-text="https://eramons.github.io/techblog/post/nextcloud/#12-install-and-configure-_kubectl_-and-_doctl_" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 1.2. Install and configure <em>kubectl</em> and <em>doctl</em>" href="#12-install-and-configure-_kubectl_-and-_doctl_"><svg class="icon link"><use xlink:href="#link"></use></svg></a></h3></div>
<p>As I waited for the provisioning of the cluster, I installed version 1.19.3 of <em>kubectl</em>:</p>
<pre tabindex="0"><code>eramon@pacharan:~/dev$ curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.19.3/bin/linux/amd64/kubectl
</code></pre><p><em>NOTE: the kubectl version must match the K8s version of the cluster</em></p>
<pre tabindex="0"><code>eramon@pacharan:~/dev$ chmod +x ./kubectl
eramon@pacharan:~/dev$ sudo mv ./kubectl /usr/local/bin/kubectl
eramon@pacharan:~/dev$ kubectl version --client
Client Version: version.Info{Major:&#34;1&#34;, Minor:&#34;19&#34;, GitVersion:&#34;v1.19.3&#34;, GitCommit:&#34;1e11e4a2108024935ecfcb2912226cedeafd99df&#34;, GitTreeState:&#34;clean&#34;, BuildDate:&#34;2020-10-14T12:50:19Z&#34;, GoVersion:&#34;go1.15.2&#34;, Compiler:&#34;gc&#34;, Platform:&#34;linux/amd64&#34;}
</code></pre><p>I also downloaded the <em>doctl</em> tool as recommended by the DigitalOcean wizard:</p>
<pre tabindex="0"><code>eramon@pacharan:~/dev$ wget https://github.com/digitalocean/doctl/releases/download/v1.54.0/doctl-1.54.0-linux-amd64.tar.gz
eramon@pacharan:~/dev$ tar xvzf doctl-1.54.0-linux-amd64.tar.gz
eramon@pacharan:~/dev$ sudo mv doctl /usr/local/bin/
</code></pre><p>I used <em>doctl</em> for automated certificate management to access the K8s API with kubectl and download of the configuration file. Following the instructions, I first ran:</p>
<pre tabindex="0"><code>eramon@pacharan:~/dev$ doctl auth init
Please authenticate doctl for use with your DigitalOcean account. You can generate a token in the control panel at https://cloud.digitalocean.com/account/api/tokens

Enter your access token: 
Validating token... OK
</code></pre><p>I created the access token on the URL above and gave it the same name as the cluster. I copied it to the clipboard and pasted it on the console as instructed.</p>
<p>Then I used <em>doctl</em> to generate the configuration file:</p>
<pre tabindex="0"><code>eramon@pacharan:~/dev$ doctl kubernetes cluster kubeconfig save eramonk8s
Notice: Adding cluster credentials to kubeconfig file found in &#34;/home/eramon/.kube/config&#34;
Notice: Setting current-context to do-fra1-eramonk8s
</code></pre><p>After this I was able to connect to my cluster via kubectl:</p>
<pre tabindex="0"><code>eramon@pacharan:~/dev$ kubectl cluster-info
Kubernetes master is running at https://73c21301-5143-42fa-ab21-1c4c54e9b1f0.k8s.ondigitalocean.com
CoreDNS is running at https://73c21301-5143-42fa-ab21-1c4c54e9b1f0.k8s.ondigitalocean.com/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
</code></pre><p>Continuing with the wizard on the browser, I installed the following <em>1-Click Apps</em>:</p>
<ul>
<li>NGINX Ingress Controller</li>
<li>Kubernetes Monitoring Stack</li>
</ul>
<p>Over the control panel I was able to access the <em>Kubernets Dashboard</em> to monitor the status of the cluster :)</p>
<div class="gblog-post__anchorwrap"><h2 id="2-software-components-docker-images-and-k8s-manifests">2. Software components, docker images and K8s manifests<a data-clipboard-text="https://eramons.github.io/techblog/post/nextcloud/#2-software-components-docker-images-and-k8s-manifests" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 2. Software components, docker images and K8s manifests" href="#2-software-components-docker-images-and-k8s-manifests"><svg class="icon link"><use xlink:href="#link"></use></svg></a></h2></div>
<p>Nextcloud is built upon the following components:</p>
<ul>
<li>Persistent storage to save content</li>
<li>MariaDB for metadata storage</li>
<li>The nextcloud webapp: PHP + Apache</li>
</ul>
<p>For persistent storage I would use the persistent volumes offered as service by DigitalOcean.</p>
<p>For both mariadb and nextcloud there are official docker images available in dockerhub.</p>
<p>With all this in mind, I was able to start writting the K8s manifests.</p>
<div class="gblog-post__anchorwrap"><h3 id="21-secrets">2.1 Secrets<a data-clipboard-text="https://eramons.github.io/techblog/post/nextcloud/#21-secrets" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 2.1 Secrets" href="#21-secrets"><svg class="icon link"><use xlink:href="#link"></use></svg></a></h3></div>
<p><em>Kubernetes Secrets let you store and manage sensitive information, such as passwords.</em></p>
<p>I started with the secrets I would need for the mariadb and nextcloud deployments later. Usually I generate the secrets manually, this time I used a manifest and included it as part of <em>kustomization.yaml</em>, just taking care not to commit the yaml file containing the passwords, but a <em>example</em> version of it with placeholders.</p>
<p><em>Kustomize provides a way to customize application configuration and it is built into kubectl as &ldquo;apply -k&rdquo;.</em></p>
<p>Following secrets are needed for the mariadb and nextcloud containers:</p>
<ul>
<li>A <em>MYSQL_DATABASE</em> which I would set to <em>nextcloud</em>, needed for both mariadb and nextcloud.</li>
<li>A <em>MYSQL_USER</em> which I would set to <em>nextcloud</em> too, needed for both mariadb and nextcloud.</li>
<li>A <em>MYSQL_PASSWORD</em> which I would generate with <em>pwgen</em> and encode to have a base-64-encoded string, needed for both mariadb and nextcloud.</li>
<li>A <em>MYSQL_ROOT_PASSWORD</em>, which I would set - to simplify - with the same value as the <em>MYSQL_PASSWORD</em></li>
</ul>
<p>Install pwgen:</p>
<pre tabindex="0"><code>eramon@pacharan:~/dev/kubenextcloud$ sudo apt-get install pwgen
</code></pre><p>Use pwgen to generate a random password for mariadb:</p>
<pre tabindex="0"><code>eramon@pacharan:~/dev/kubenextcloud$ echo -n `pwgen -s -1 16`
</code></pre><p>Note the output.</p>
<p>As mentioned, I used this password for both the <em>MYSQL_PASSWORD</em> and the <em>MYSQL_ROOT_PASSWORD</em>.</p>
<p>For <em>MYSQL_DATABASE</em> and <em>MYSQL_USER</em>, I set <em>nextcloud</em>, use openssl to base64-encode &ldquo;nextcloud&rdquo;:</p>
<pre tabindex="0"><code>eramon@pacharan:~/dev/kubenextcloud$ echo -n &#39;nextcloud&#39; | openssl base64
bmV4dGNsb3Vk
</code></pre><p>Having all the values, write a manifest for the secrets, using the generated passwords:</p>
<pre tabindex="0"><code>apiVersion: v1
kind: Secret
metadata:
  name: mariadb-secrets
type: Opaque
data:
  MYSQL_DATABASE: bmV4dGNsb3Vk 
  MYSQL_USER: bmV4dGNsb3Vk 
  MYSQL_PASSWORD: base64-encoded-pwgen-generated-password 
  MYSQL_ROOT_PASSWORD: base64-encoded-pwgen-generated-password 
</code></pre><p>Create a new <em>kustomize.yaml</em> file and included the manifest for the secrets there.</p>
<div class="gblog-post__anchorwrap"><h3 id="22-persistent-volumes">2.2 Persistent Volumes<a data-clipboard-text="https://eramons.github.io/techblog/post/nextcloud/#22-persistent-volumes" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 2.2 Persistent Volumes" href="#22-persistent-volumes"><svg class="icon link"><use xlink:href="#link"></use></svg></a></h3></div>
<p><em>A PersistentVolumeClaim (PVC) is a request for storage by a user. A PersistentVolume (PV) is a piece of storage in the cluster that has been provisioned by an administrator or dynamically provisioned.</em></p>
<p>To see the possibilities for the creation of a persistent volume with DigitalOcean, I got to the <em>Volumes</em> section on the <em>Manage</em> menu.</p>
<p><em>NOTE: one persistent volume claim was already created - apparently it was automatically set for the use of the monitoring tool.</em></p>
<p>I went to the <em>How to Add Block Storage Volumes to Kubernets Clusters</em> tutorial. Taking the code from the example, I created a manifest for a 3GB block storage volume to persist the end user data managed by nextcloud:</p>
<p><a href="https://github.com/eramons/kubenextcloud/blob/master/nextcloud-pvc.yaml">nextcloud-pvc.yaml</a></p>
<p>I created an additional volume for the storage of the mariadb metadata with size 2GB, to persist the nextcloud metadata stored on mariadb:</p>
<p><a href="https://github.com/eramons/kubenextcloud/blob/master/mariadb-pvc.yaml">mariadb-pvc.yaml</a></p>
<p>For managing all manifests and easing the deployment, I would use <em>kustomize</em>.</p>
<p>Add the pvc manifests to <em>kustomization.yaml</em>.</p>
<div class="gblog-post__anchorwrap"><h3 id="23-mariadb">2.3 MariaDB<a data-clipboard-text="https://eramons.github.io/techblog/post/nextcloud/#23-mariadb" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 2.3 MariaDB" href="#23-mariadb"><svg class="icon link"><use xlink:href="#link"></use></svg></a></h3></div>
<p>Create manifest file for the mariadb deployment:</p>
<p><a href="https://github.com/eramons/kubenextcloud/blob/master/mariadb-deployment.yaml">mariadb-deployment.yaml</a></p>
<p><em>A Deployment provides declarative updates for Pods and ReplicaSets.</em></p>
<p>The mariadb docker image allows the creation of a database upon creation of the container. When you start the mariadb image, you can adjust the configuration of the MariaDB instance by passing one or more environment variables on the docker run command line. Do note that none of the variables below will have any effect if you start the container with a data directory that already contains a database: any pre-existing database will always be left untouched on container startup.</p>
<p>The deployment manifest requires configuring the following environment variables:</p>
<ul>
<li><em>MYSQL_ROOT_PASSWORD</em>: specifies the password that will be set for the MariaDB root superuser account (mandatory)</li>
<li><em>MYSQL_DATABASE</em>: allows to specify the name of a database to be created on image startup (optional)</li>
<li><em>MYSQL_USER</em>, <em>MYSQL_PASSWORD</em>: used in conjunction to create a new user and to set that user&rsquo;s password (optional)</li>
</ul>
<p><em>NOTE In order for mariadb to re-create the nextcloud database, the persistent volume must be deleted. It&rsquo;s not enough with delete the container. The environment variables only work if the database is started for the first time.</em></p>
<p>Create manifest file for the mariadb service:</p>
<p><a href="https://github.com/eramons/kubenextcloud/blob/master/mariadb-service.yaml">mariadb-service.yaml</a></p>
<p><em>A service is an abstract way to expose an application running on a set of pods as a network service.</em></p>
<p>Add the deployment and service manifest files to <em>kustomization.yaml</em>.</p>
<div class="gblog-post__anchorwrap"><h3 id="24-redis">2.4 Redis<a data-clipboard-text="https://eramons.github.io/techblog/post/nextcloud/#24-redis" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 2.4 Redis" href="#24-redis"><svg class="icon link"><use xlink:href="#link"></use></svg></a></h3></div>
<p>The performance of nextcloud server can be improved using memory caching. Redis provides local and distributed caching as well as transactional file locking.</p>
<p>Create the manifest file for the redis deployment:</p>
<p><a href="https://github.com/eramons/kubenextcloud/blob/master/redis-deployment.yaml">redis-deployment.yaml</a></p>
<p>Create the manifest file for the redis service:</p>
<p><a href="https://github.com/eramons/kubenextcloud/blob/master/redis-service.yaml">redis-service.yaml</a></p>
<p>For nextcloud to use redis, we&rsquo;ll need to set the environment variable <em>REDIS_HOST</em> on the nextcloud container.</p>
<div class="gblog-post__anchorwrap"><h3 id="25-nextcloud">2.5 Nextcloud<a data-clipboard-text="https://eramons.github.io/techblog/post/nextcloud/#25-nextcloud" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 2.5 Nextcloud" href="#25-nextcloud"><svg class="icon link"><use xlink:href="#link"></use></svg></a></h3></div>
<p>Create the manifest file for the nextcloud deployment:</p>
<pre tabindex="0"><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: nextcloud 
  labels:
    app: nextcloud 
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nextcloud 
  template:
    metadata:
      labels:
        app: nextcloud
    spec:
      volumes:
      - name: nextcloud-storage
        persistentVolumeClaim: 
          claimName: nextcloud-pvc
      containers:
        - image: nextcloud:apache
          name: nextcloud 
          ports:
            - containerPort: 80
          env:
            - name: REDIS_HOST
              value: redis
            - name: MYSQL_HOST
              value: mariadb 
            - name: MYSQL_DATABASE
              valueFrom:
                secretKeyRef:
                  key: MYSQL_DATABASE
                  name: mariadb-secrets
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: MYSQL_PASSWORD
                  name: mariadb-secrets
            - name: MYSQL_USER
              valueFrom:
                secretKeyRef:
                  key: MYSQL_USER
                  name: mariadb-secrets
            - name: NEXTCLOUD_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: MYSQL_PASSWORD
                  name: mariadb-secrets 
            - name: NEXTCLOUD_ADMIN_USER
              value: &#34;admin&#34;
            - name: NEXTCLOUD_TRUSTED_DOMAINS 
              value: mydomain.com 
          volumeMounts:
            - mountPath: /var/www/html
              name: nextcloud-storage
</code></pre><p>The nextcloud image supports auto-configuration via environment variables. You can preconfigure everything that is asked on the install page on first run:</p>
<ul>
<li>MYSQL_DATABASE: Name of the database using mysql / mariadb</li>
<li>MYSQL_USER: Username for the database using mysql / mariadb</li>
<li>MYSQL_PASSWORD: Password for the database user using mysql / mariadb</li>
<li>MYSQL_HOST: Hostname of the database server using mysql / mariadb</li>
</ul>
<p>With a complete configuration by using all variables for your database type, you can additionally configure your Nextcloud instance by setting admin user and password:</p>
<ul>
<li>NEXTCLOUD_ADMIN_USER: Name of the Nextcloud admin user. I used <em>admin</em>.</li>
<li>NEXTCLOUD_ADMIN_PASSWORD: Password for the Nextcloud admin user. For simplification - since this is just a experimental setup - I configured it to be the same password as the one used for the nextcloud database.</li>
</ul>
<p>One or more trusted domains can be set through environment variable too:</p>
<ul>
<li>NEXTCLOUD_TRUSTED_DOMAINS: optional space-separated list of IPs or domains. The IP of the loadbalancer or the domain <em>mydomain.com</em> must be configured here.</li>
</ul>
<p>In order for nextcloud to see and use the redis service, we need to include an additional environment variable:</p>
<ul>
<li>REDIS_HOST: name of the redis service which in this case is <em>redis</em>.</li>
</ul>
<p>Create manifest file for the nextcloud service:</p>
<p><a href="https://github.com/eramons/kubenextcloud/blob/master/nextcloud-service.yaml">nextcloud-service.yaml</a></p>
<p>Add the nextcloud deployment and service manifest files to <em>kustomization.yaml</em>.</p>
<div class="gblog-post__anchorwrap"><h2 id="3-ingress">3. Ingress<a data-clipboard-text="https://eramons.github.io/techblog/post/nextcloud/#3-ingress" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 3. Ingress" href="#3-ingress"><svg class="icon link"><use xlink:href="#link"></use></svg></a></h2></div>
<p><em>Kubernetes Ingresses allow you to flexibly route traffic from outside your Kubernetes cluster to Services inside of your cluster. This is accomplished using Ingress Resources, which define rules for routing HTTP and HTTPS traffic to Kubernetes Services, and Ingress Controllers, which implement the rules by load balancing traffic and routing it to the appropriate backend Services.</em></p>
<p>I had already installed the <em>nginx-ingress-controller</em> as <em>1-click app</em> when setting up the cluster at the beginning. To make sure it was running:</p>
<pre tabindex="0"><code>eramon@pacharan:~/dev/kubenextcloud$ kubectl get pods -n ingress-nginx
NAME                                                      READY   STATUS    RESTARTS   AGE
nginx-ingress-ingress-nginx-controller-7898d5969d-sgph4   1/1     Running   0          110m
</code></pre><p>Create manifest file for ingress:</p>
<pre tabindex="0"><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: nextcloud-ingress
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    cert-manager.io/acme-challenge-type: http01
spec:
  tls:
  - hosts: 
    - nextcloud.mydomain.com 
    secretName: nextcloud-tls 
  rules:
  - host: nextcloud.mydomain.com 
    http: 
      paths: 
      - path: /
        backend:
          serviceName: nextcloud
          servicePort: 80
</code></pre><p>Don&rsquo;t forget to include the <em>tls</em> directive and the certbot and letsencrypt anotations for the ssl server certificate to be automatically generated by cerbot.</p>
<p>Add the ingress manifest file to <em>kustomization.yaml</em>.</p>
<div class="gblog-post__anchorwrap"><h2 id="4-dns">4. DNS<a data-clipboard-text="https://eramons.github.io/techblog/post/nextcloud/#4-dns" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 4. DNS" href="#4-dns"><svg class="icon link"><use xlink:href="#link"></use></svg></a></h2></div>
<p>I have my domain <em>mydomain.com</em> registered and hosted by <em>godaddy</em>. I use Cloudflare to manage the DNS configuration for my projects.</p>
<p>I listed the services on namespace <em>nginx-ingress</em> to find out the public IP of the load balancer of the cluster:</p>
<pre tabindex="0"><code>eramon@pacharan:~/dev/kubenextcloud$ kubectl get service -n ingress-nginx
NAME                                               TYPE           CLUSTER-IP      EXTERNAL-IP       PORT(S)                      AGE
nginx-ingress-ingress-nginx-controller             LoadBalancer   10.245.56.207   PUBLICIP	    80:32519/TCP,443:30323/TCP   111m
</code></pre><p>On Cloudflare, I added a new DNS entry:</p>
<ul>
<li>Type: A record</li>
<li>Name: <em>nextcloud.mydomain.com</em></li>
<li>Content: PUBLIC_IP</li>
</ul>
<div class="gblog-post__anchorwrap"><h2 id="5-certmanager-and-cluster-issuer">5. Certmanager and Cluster Issuer<a data-clipboard-text="https://eramons.github.io/techblog/post/nextcloud/#5-certmanager-and-cluster-issuer" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 5. Certmanager and Cluster Issuer" href="#5-certmanager-and-cluster-issuer"><svg class="icon link"><use xlink:href="#link"></use></svg></a></h2></div>
<p>Install certmanager and its custom resource definitions directly from manifest:</p>
<pre tabindex="0"><code>eramon@pacharan:~/dev/kubenextcloud$ kubectl apply --validate=false -f https://github.com/jetstack/cert-manager/releases/download/v0.16.1/cert-manager.yaml
</code></pre><p>Verify the installation:</p>
<pre tabindex="0"><code>eramon@pacharan:~/dev/kubenextcloud$ kubectl get pods --namespace cert-manager
NAME                                      READY   STATUS    RESTARTS   AGE
cert-manager-cainjector-fc6c787db-g9d5g   1/1     Running   0          67s
cert-manager-d994d94d7-7fzkd              1/1     Running   0          67s
cert-manager-webhook-845d9df8bf-d98vl     1/1     Running   0          66s
</code></pre><p>After installing certmanager, write a manifest for the cluster issuer:</p>
<pre tabindex="0"><code>apiVersion: cert-manager.io/v1alpha2
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    # The ACME server URL
    server: https://acme-v02.api.letsencrypt.org/directory
    # EMail address used for ACME registration
    email: nextcloud@mydomain.com
    # Name of a secret to store the ACME account private key
    privateKeySecretRef:
      name: letsencrypt-prod

    # Enable HTTP01 challenge provider using nginx
    solvers:
    - http01:
        ingress:
          class: nginx
</code></pre><p><em>Issuers (and ClusterIssuers) represent a certificate authority from which signed x509 certificates can be obtained, such as Let’s Encrypt.</em></p>
<p>Add the cluster issuer to <em>kustomization.yaml</em>.</p>
<div class="gblog-post__anchorwrap"><h2 id="6-deployment">6. Deployment<a data-clipboard-text="https://eramons.github.io/techblog/post/nextcloud/#6-deployment" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 6. Deployment" href="#6-deployment"><svg class="icon link"><use xlink:href="#link"></use></svg></a></h2></div>
<p>After completing all manifests and including them in <em>kustomization.yaml</em>, the file looked like this:</p>
<p><a href="https://github.com/eramons/kubenextcloud/blob/master/kustomization.yaml">kustomization.yaml</a></p>
<p>Finally, to deploy everything:</p>
<pre tabindex="0"><code>eramon@pacharan:~/dev/kubenextcloud$ kubectl apply -k .
</code></pre><p>When accessing <em>nextcloud.mydomain.com</em> I was greeted with the login page. I logged in as Administrator and created a user <em>eramon</em> in the administration console, with e-mail <em>eramon@mydomain.com</em> (the e-mail is used as login name but it&rsquo;s arbitrary otherwise, since we&rsquo;re not managing an own mail server) and a password.</p>
<p>I logged out and logged in again, this time using the newly created user.</p>
<div class="gblog-post__anchorwrap"><h2 id="7-synchronize-with-e-rom">7. Synchronize with /e ROM<a data-clipboard-text="https://eramons.github.io/techblog/post/nextcloud/#7-synchronize-with-e-rom" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 7. Synchronize with /e ROM" href="#7-synchronize-with-e-rom"><svg class="icon link"><use xlink:href="#link"></use></svg></a></h2></div>
<p>On my LG G3, I added a new /e account:</p>
<ul>
<li>e-mail: <em>eramon@mydomain.com</em> (the user I created before)</li>
<li>password: the password I set before</li>
<li>server: <em><a href="https://nextcloud.mydomain.com">https://nextcloud.mydomain.com</a></em></li>
</ul>
<p>In the account manager, I set the synching options to synchronize photos and calendar only.</p>
<p>It worked. My /e phone was now connected to my own nextcloud installation running on K8s :)</p>
<p><img src="/techblog/img/nextcloud.jpg" alt="nextcloud"></p>
<div class="gblog-post__anchorwrap"><h2 id="links">Links<a data-clipboard-text="https://eramons.github.io/techblog/post/nextcloud/#links" class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Links" href="#links"><svg class="icon link"><use xlink:href="#link"></use></svg></a></h2></div>
<p><a href="https://www.digitalocean.com">DigitalOcean</a></p>
<p><a href="https://en.wikipedia.org/wiki/Nextcloud">Nextcloud wiki</a></p>
<p><a href="https://nextcloud.com">Nextcloud</a></p>
<p><a href="https://github.com/digitalocean/doctl/releases">Doctl</a></p>
<p><a href="https://www.digitalocean.com/docs/kubernetes/how-to/connect-to-cluster">How to connect to a DO K8s Cluster</a></p>
<p><a href="https://www.digitalocean.com/docs/kubernetes/how-to/add-volumes">How to Add Block Storage Volumes to K8s clusters</a></p>
<p><a href="https://www.cloudflare.com">Cloudflare</a></p>
<p><a href="https://hub.docker.com/_/nextcloud">nextcloud@dockerhub</a></p>
<p><a href="https://hub.docker.com/_/mariadb">mariadb@dockerhub</a></p>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-nginx-ingress-with-cert-manager-on-digitalocean-kubernetes">Ingress and Certmanager on DO K8s</a></p>
<p><a href="https://kubernetes.io/docs">K8s Documentation</a></p>
<p><a href="https://docs.nextcloud.com/server/15/admin_manual">Nextcloud Documentation</a></p>


        </section>
    </article>

        </main>

        <footer class="gblog-footer">
    <div class="container">
        <div class="flex flex-wrap align-center">
            
            
            <span class="gblog-footer__item">
                <svg class="icon email"><use xlink:href="#email"></use></svg>
                <a href='/techblog/contact/' class="gblog-footer__link">Contact</a>
            </span>
            
            
            
            
            <span class="gblog-footer__item">
                Content licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="gblog-footer__link no-wrap">CC BY-SA 4.0</a>
            </span>
            
        </div>
        <div class="flex flex-wrap align-center">
            <span class="gblog-footer__item">
                Built with <a href="https://gohugo.io/" class="gblog-footer__link">Hugo</a> and
                <svg class="icon heart"><use xlink:href="#heart"></use></svg>
            </span>
        </div>
        
    </div>
</footer>

    </div>

    
<script defer src="/techblog/js/clipboard-f06c52bfdd.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function(event) {
        var clipboard = new ClipboardJS('.clip');
    });
</script>


</body>
</html>
